<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Performance · CellListMap.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img class="docs-light-only" src="../assets/logo.svg" alt="CellListMap.jl logo"/><img class="docs-dark-only" src="../assets/logo-dark.svg" alt="CellListMap.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CellListMap.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../PeriodicSystems/">PeriodicSystems interface</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../pbc/">Periodic conditions</a></li><li><a class="tocitem" href="../parallelization/">Parallelization</a></li><li><a class="tocitem" href="../units_etc/">Units, autodiff, etc.</a></li><li class="is-active"><a class="tocitem" href>Performance</a><ul class="internal"><li><a class="tocitem" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists"><span>Preallocating auxiliary arrays: threaded output and cell lists</span></a></li><li><a class="tocitem" href="#Optimizing-the-cell-grid"><span>Optimizing the cell grid</span></a></li><li><a class="tocitem" href="#Output-progress"><span>Output progress</span></a></li><li><a class="tocitem" href="#Some-benchmarks"><span>Some benchmarks</span></a></li></ul></li><li><a class="tocitem" href="../options/">Options</a></li><li><a class="tocitem" href="../python/">From Python</a></li><li><a class="tocitem" href="../help/">Help entries</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Performance</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Performance</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/m3g/CellListMap.jl/blob/main/docs/src/performance.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Performance-tunning-and-additional-options"><a class="docs-heading-anchor" href="#Performance-tunning-and-additional-options">Performance tunning and additional options</a><a id="Performance-tunning-and-additional-options-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-tunning-and-additional-options" title="Permalink"></a></h1><h2 id="Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists"><a class="docs-heading-anchor" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists">Preallocating auxiliary arrays: threaded output and cell lists</a><a id="Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists" title="Permalink"></a></h2><h3 id="Preallocating-the-cell-lists-and-cell-list-auxiliary-arrays"><a class="docs-heading-anchor" href="#Preallocating-the-cell-lists-and-cell-list-auxiliary-arrays">Preallocating the cell lists and cell list auxiliary arrays</a><a id="Preallocating-the-cell-lists-and-cell-list-auxiliary-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-the-cell-lists-and-cell-list-auxiliary-arrays" title="Permalink"></a></h3><p>The arrays containing the cell lists can be initialized only once, and then updated. This is useful for iterative runs. Note that, since the list size depends on the box size and cutoff, if the box properties changes some arrays might be increased (never shrink) on this update. </p><pre><code class="language-julia hljs"># Initialize cell lists with initial coordinates
cl = CellList(x,box)
# Allocate auxiliary arrays for threaded cell list construction
aux = CellListMap.AuxThreaded(cl)
for i in 1:nsteps
    x = ... # new coordinates
    box = Box(sides,cutoff) # perhaps the box has changed
    cl = UpdateCellList!(x,box,cl,aux) 
    map_pairwise!(...)
end</code></pre><p>The procedure is identical if using two sets of coordinates, in which case, one would do:</p><pre><code class="language-julia hljs">cl = CellList(x,y,box)
aux = CellListMap.AuxThreaded(cl)
for i in 1:nsteps
    x = ... # new coordinates
    box = Box(sides,cutoff) # perhaps the box has changed
    cl = UpdateCellList!(x,y,box,cl,aux)
    map_pairwise(...)
end</code></pre><p>By passing the <code>aux</code> auxiliary structure, the <code>UpdateCellList!</code> functions will only allocate some minor variables associated to the launching of multiple threads and, possibly, to the expansion of the cell lists if the box or the number of particles became greater. </p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>If the number of batches of threading is changed, the structure of auxiliary arrays must be reinitialized. Otherwise, incorrect results can be obtained.</p></div></div><h3 id="Preallocating-threaded-output-auxiliary-arrays"><a class="docs-heading-anchor" href="#Preallocating-threaded-output-auxiliary-arrays">Preallocating threaded output auxiliary arrays</a><a id="Preallocating-threaded-output-auxiliary-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-threaded-output-auxiliary-arrays" title="Permalink"></a></h3><p>On parallel runs, note that <code>output_threaded</code> is, by default, initialized on the call to <code>map_pairwise!</code>. Thus, if the calculation must be run multiple times (for example, for several steps of a trajectory), it is probably a good idea to preallocate the threaded output, particularly if it is a large array. For example, the arrays of forces should be created only once, and reset to zero after each use:</p><pre><code class="language-julia hljs">forces = zeros(SVector{3,Float64},N)
forces_threaded = [ deepcopy(forces) for i in 1:nbatches(cl) ]
for i in 1:nsteps
    map_pairwise!(f, forces, box, cl, output_threaded=forces_threaded)
    # work with the final forces vector
    ...
    # Reset forces_threaded
    for i in 1:nbatches(cl)
        @. forces_threaded[i] = zero(SVector{3,Float64}) 
    end
end</code></pre><p>In this case, the <code>forces</code> vector will be updated by the default reduction method. <code>nbatches(cl)</code> is the number of batches of the parallel calculation, which is defined on the construction of the cell list (see the <strong>Parallelization</strong> section).</p><h2 id="Optimizing-the-cell-grid"><a class="docs-heading-anchor" href="#Optimizing-the-cell-grid">Optimizing the cell grid</a><a id="Optimizing-the-cell-grid-1"></a><a class="docs-heading-anchor-permalink" href="#Optimizing-the-cell-grid" title="Permalink"></a></h2><p>The partition of the space into cells is dependent on a parameter <code>lcell</code> which can be passed to <code>Box</code>. For example:</p><pre><code class="language-julia hljs">box = Box(x,box,lcell=2)
cl = CellList(x,box)
map_pairwise!(...)</code></pre><p>This parameter determines how fine is the mesh of cells. There is a trade-off between the number of cells and the number of particles per cell. For low-density systems, greater meshes are better, because each cell will have only a few particles and the computations loop over a smaller number of cells. For dense systems, it is better to run over more cells with less particles per cell. It is a good idea to test different values of <code>lcell</code> to check which is the optimal choice for your system. Usually the best value is <code>lcell=1</code>, because in <code>CellListMap</code> implements a method to avoid spurious computations of distances on top of the cell lists, but for very dense systems, or for very large cutoffs (meaning, for situations in which the number of particles per cell may be very large), a greater <code>lcell</code> may provide a better performance. It is unlikely that <code>lcell &gt; 3</code> is useful in any practical situation. For molecular systems with normal densities <code>lcell=1</code> is likely the optimal choice. The performance can be tested using the progress meter, as explained below.  </p><p>As a rough guide, <code>lcell &gt; 1</code> is only worthwhile if the number of particles per cell is greater than  <code>~200-400</code>.  </p><h2 id="Output-progress"><a class="docs-heading-anchor" href="#Output-progress">Output progress</a><a id="Output-progress-1"></a><a class="docs-heading-anchor-permalink" href="#Output-progress" title="Permalink"></a></h2><p>For long-running computations, the user might want to see the progress. A progress meter can be turned on with the <code>show_progress</code> option. For example:</p><pre><code class="language-julia hljs">map_pairwise!(f,output,box,cl,show_progress=true)</code></pre><p>whill print something like:</p><pre><code class="language-julia-repl hljs">Progress:  43%|█████████████████                    | ETA: 0:18:25</code></pre><p>Thus, besides being useful for following the progress of a long run, it is useful to test different values of <code>lcell</code> to tune the performance of the code, by looking at the estimated time to finish (ETA) and killing the execution after a sample run. The default and recommended option for production runs is to use <code>show_progress=false</code>, because tracking the progress introduces a small overhead into the computation. </p><h2 id="Some-benchmarks"><a class="docs-heading-anchor" href="#Some-benchmarks">Some benchmarks</a><a id="Some-benchmarks-1"></a><a class="docs-heading-anchor-permalink" href="#Some-benchmarks" title="Permalink"></a></h2><h3 id="Computing-a-histogram-of-pairwise-velocities"><a class="docs-heading-anchor" href="#Computing-a-histogram-of-pairwise-velocities">Computing a histogram of pairwise velocities</a><a id="Computing-a-histogram-of-pairwise-velocities-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-a-histogram-of-pairwise-velocities" title="Permalink"></a></h3><p>The goal here is to provide a good implementation of cell lists. We compare it with the implementation of the nice cython/python <a href="https://github.com/astropy/halotools">halotools</a> package, in the computation of an histogram of mean pairwise velocities. </p><center>
<img src=https://raw.githubusercontent.com/lmiq/PairVelocities/main/data/cd_v0.5.3.png>
<br>
<img src=https://raw.githubusercontent.com/lmiq/PairVelocities/main/data/cv_v0.5.3.png>
</center><p>The full test is available <a href="https://github.com/lmiq/PairVelocities">at this</a> repository. And we kindly thank <a href="https://github.com/florpi">Carolina Cuesta</a> for providing the example. These benchmarks were run on an Intel i7 8th gen laptop, with 4 cores (8 threads). </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../units_etc/">« Units, autodiff, etc.</a><a class="docs-footer-nextpage" href="../options/">Options »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Friday 26 August 2022 00:42">Friday 26 August 2022</span>. Using Julia version 1.8.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
