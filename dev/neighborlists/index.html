<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Neighbor lists · CellListMap.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img class="docs-light-only" src="../assets/logo.svg" alt="CellListMap.jl logo"/><img class="docs-dark-only" src="../assets/logo-dark.svg" alt="CellListMap.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CellListMap.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../PeriodicSystems/">PeriodicSystems interface</a></li><li class="is-active"><a class="tocitem" href>Neighbor lists</a><ul class="internal"><li><a class="tocitem" href="#Non-periodic-systems"><span>Non-periodic systems</span></a></li><li><a class="tocitem" href="#Periodic-systems"><span>Periodic systems</span></a></li><li><a class="tocitem" href="#In-place-computation-of-neighbor-lists"><span>In-place computation of neighbor lists</span></a></li><li><a class="tocitem" href="#Options"><span>Options</span></a></li></ul></li><li><a class="tocitem" href="../LowLevel/">Low level interface</a></li><li><a class="tocitem" href="../ecosystem/">Ecosystem integration</a></li><li><a class="tocitem" href="../python/">From Python</a></li><li><a class="tocitem" href="../help/">Help entries</a></li><li><a class="tocitem" href="../citation/">Citation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Neighbor lists</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Neighbor lists</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/m3g/CellListMap.jl/blob/main/docs/src/neighborlists.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Neighbor-lists"><a class="docs-heading-anchor" href="#Neighbor-lists">Neighbor lists</a><a id="Neighbor-lists-1"></a><a class="docs-heading-anchor-permalink" href="#Neighbor-lists" title="Permalink"></a></h1><p>Neighbor lists can be computed, returning all pairs of particles that are found within the cutoff, and the corresponding distances.  </p><ul><li><a href="#Non-periodic-systems">Non-periodic systems</a></li><li><a href="#Periodic-systems">Periodic systems</a></li><li><a href="#In-place-computation-of-neighbor-lists">In-place computation of neighbor lists</a></li><li><a href="#Options">Options</a></li></ul><h2 id="Non-periodic-systems"><a class="docs-heading-anchor" href="#Non-periodic-systems">Non-periodic systems</a><a id="Non-periodic-systems-1"></a><a class="docs-heading-anchor-permalink" href="#Non-periodic-systems" title="Permalink"></a></h2><p>Without periodic boundary conditions, just provide the coordinates and the cutoff:</p><pre><code class="language-julia-repl hljs">julia&gt; using CellListMap

julia&gt; x = [ rand(2) for _ in 1:10_000 ];

julia&gt; neighborlist(x,0.05)
376457-element Vector{Tuple{Int64, Int64, Float64}}:
 (1, 363, 0.04855594810064624)
 (1, 513, 0.03356381123125866)
 (1, 1209, 0.005159666709130686)
 ⋮
 (6575, 7378, 0.03791567990447959)
 (7378, 3450, 0.01748757015908321)</code></pre><p>If the neighbor lists between two sets of points are required, use the following notation:</p><pre><code class="language-julia-repl hljs">julia&gt; x = rand(SVector{3,Float64},10^4);

julia&gt; y = rand(SVector{3,Float64},10^3);

julia&gt; list = neighborlist(x,y,0.1)
37309-element Vector{Tuple{Int64, Int64, Float64}}:
 (1, 971, 0.09867846773727411)
 (1, 567, 0.06630101425431004)
 (1, 3, 0.04103170149300593)
 ⋮
 (10000, 156, 0.08549899843141298)
 (10000, 444, 0.0737386384422871)</code></pre><p>where, similarly, the third parameter is the cutoff. The returning array contains tuples with the index of the particle in the first vector, the index of the particle in the second vector, and their distance.</p><h2 id="Periodic-systems"><a class="docs-heading-anchor" href="#Periodic-systems">Periodic systems</a><a id="Periodic-systems-1"></a><a class="docs-heading-anchor-permalink" href="#Periodic-systems" title="Permalink"></a></h2><p>If periodic boundary conditions are used, the <code>unitcell</code> can be provided explicitly as keyword parameters:</p><pre><code class="language-julia-repl hljs">julia&gt; x = [ rand(2) for _ in 1:10_000 ]; 

julia&gt; neighborlist(x, 0.05; unitcell=[1,1])
392100-element Vector{Tuple{Int64, Int64, Float64}}:
 (1, 5, 0.03445098850037766)
 (1, 393, 0.039448810592487206)
 (1, 1632, 0.02276457565643465)
 ⋮
 (9501, 9781, 0.03351665194098955)
 (9501, 5429, 0.04199258248973222)</code></pre><p>In the example above, an <code>Orthorhombic</code> cell was assumed, and thus a vector of sides was provided. For general periodic boundary conditions, a unit cell matrix can be provided, for example:</p><pre><code class="language-julia-repl hljs">julia&gt; neighborlist(x, 0.05; unitcell=[1.0 0.5; 0.5 1.0])
580693-element Vector{Tuple{Int64, Int64, Float64}}:
 (1, 457, 0.03935441952786555)
 (1, 1467, 0.033407692174569875)
 (1, 1767, 0.04490555313598093)
 ⋮
 (3652, 8475, 0.04721628783510375)
 (6260, 8475, 0.04946130971686825)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Positions and unit cells can be 2 or 3-dimensional.</p></div></div><h2 id="In-place-computation-of-neighbor-lists"><a class="docs-heading-anchor" href="#In-place-computation-of-neighbor-lists">In-place computation of neighbor lists</a><a id="In-place-computation-of-neighbor-lists-1"></a><a class="docs-heading-anchor-permalink" href="#In-place-computation-of-neighbor-lists" title="Permalink"></a></h2><p>If neighbor lists are computed within a interative scenario, it is interesting preallocate all the necessary data and just update the lists at every iteration. This can be achieved by constructing the <code>InPlaceNeighborList</code>  object in advance. The performance gain of performing the operations in place might vary and may not be  important for single runs, as the allocations do not dominate the computing time. </p><p>We will first illustrate the interface for a non-parallel run:</p><pre><code class="language-julia-repl hljs">julia&gt; using CellListMap, StaticArrays

julia&gt; x = rand(SVector{3,Float64}, 10^4);

julia&gt; system = InPlaceNeighborList(x=x, cutoff=0.1, unitcell=[1,1,1], parallel=false)
InPlaceNeighborList with types: 
CellList{3, Float64}
Box{OrthorhombicCell, 3, Float64, Float64, 9}
Current list buffer size: 0</code></pre><p>Note that the buffer size has size <code>0</code>. The first time the neighbor lists are computed, the list will be allocated. We will use the <code>neighborlist!</code> (with the bang) function, because it will effectivelly  mutate the <code>system</code>, by allocating all necessary data:</p><pre><code class="language-julia-repl hljs">julia&gt; @time list = neighborlist!(system)
  0.017765 seconds (12 allocations: 7.445 MiB)
209190-element Vector{Tuple{Int64, Int64, Float64}}:
 (1, 1375, 0.09425551992016712)
 (1, 3076, 0.045320021406080775)
 (1, 3666, 0.07780146666634076)
 ⋮
 (9962, 6983, 0.07355578793348823)
 (9962, 7457, 0.07597724209140656)</code></pre><p>Now, if we modify the coordinates, we can update the system and recompute the neighbor lists:</p><pre><code class="language-julia-repl hljs">julia&gt; @time update!(system, x_new)
  0.003562 seconds
InPlaceNeighborList with types: 
CellList{3, Float64}
Box{OrthorhombicCell, 3, Float64, Float64, 9}
Current list buffer size: 209190

julia&gt; @time list = neighborlist!(system);
  0.012338 seconds</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><ul><li>Here we illustrate the behavior of the functions in their second calls, to remove the  effects of compilation on the allocation results.</li><li>The <code>cutoff</code> and <code>unitcell</code>  can be modified by providing additional keyword parameters to the <code>update!</code> function (for example <code>update!(system, x; cutoff=0.1)</code>).</li><li>Allocations can occur if the cutoff, unit cell, or number of particles change such that greater buffers are required. The number of allocations tend to disminish as  the buffers become large enough to accomodate the possible variations of the computation.</li></ul></div></div><p>For parallel runs, the allocations are minimal, but some small auxiliary data is required for the launching of multiple threads. We illustrate here the convergence of the allocations to the  minimum required for multi-threaded calculations:</p><pre><code class="language-julia-repl hljs">julia&gt; system = InPlaceNeighborList(x=x, cutoff=0.1, unitcell=[1,1,1], parallel=true);

julia&gt; @time list = neighborlist!(system);
  0.007762 seconds (230 allocations: 18.142 MiB)

julia&gt; x_new = rand(SVector{3,Float64},10^4);

julia&gt; @time update!(system, x_new)
  0.005283 seconds (20.30 k allocations: 6.200 MiB)
InPlaceNeighborList with types: 
CellList{3, Float64}
Box{OrthorhombicCell, 3, Float64, Float64, 9}
Current list buffer size: 209190

julia&gt; @time neighborlist!(system);
  0.008190 seconds (166 allocations: 6.461 MiB)

julia&gt; x_new = rand(SVector{3,Float64},10^4);

julia&gt; @time update!(system, x_new);
  0.002723 seconds (221 allocations: 208.922 KiB)

julia&gt; @time neighborlist!(system);
  0.006227 seconds (165 allocations: 2.863 MiB)

julia&gt; x_new = rand(SVector{3,Float64},10^4);

julia&gt; @time update!(system, x_new);
  0.002396 seconds (275 allocations: 144.078 KiB)

julia&gt; @time neighborlist!(system);
  0.004996 seconds (161 allocations: 15.141 KiB)</code></pre><h2 id="Options"><a class="docs-heading-anchor" href="#Options">Options</a><a id="Options-1"></a><a class="docs-heading-anchor-permalink" href="#Options" title="Permalink"></a></h2><p>Additional optional parameters can be used in a <code>neighborlist</code> call:</p><table><tr><th style="text-align: center">Keyword</th><th style="text-align: center">Values types</th><th style="text-align: center">Default</th><th style="text-align: left">About</th></tr><tr><td style="text-align: center"><code>parallel</code></td><td style="text-align: center"><code>Bool</code></td><td style="text-align: center"><code>true</code></td><td style="text-align: left">turns on and off parallelization</td></tr><tr><td style="text-align: center"><code>show_progress</code></td><td style="text-align: center"><code>Bool</code></td><td style="text-align: center"><code>false</code></td><td style="text-align: left">turns on and off progress bar</td></tr><tr><td style="text-align: center"><code>nbatches</code></td><td style="text-align: center"><code>Tuple{Int,Int}</code></td><td style="text-align: center"><code>(0,0)</code></td><td style="text-align: left">Number of batches used in parallelization (see <a href="../LowLevel/#Number-of-batches">here</a>)</td></tr><tr><td style="text-align: center"><code>autoswap</code></td><td style="text-align: center"><code>Bool</code></td><td style="text-align: center"><code>true</code></td><td style="text-align: left">(advanced) automatically choose set to construct the cell lists</td></tr></table></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../PeriodicSystems/">« PeriodicSystems interface</a><a class="docs-footer-nextpage" href="../LowLevel/">Low level interface »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Thursday 15 September 2022 23:44">Thursday 15 September 2022</span>. Using Julia version 1.8.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
