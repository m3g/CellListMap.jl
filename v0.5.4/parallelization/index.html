<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parallelization · CellListMap.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="CellListMap.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CellListMap.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../pbc/">Periodic conditions</a></li><li class="is-active"><a class="tocitem" href>Parallelization</a><ul class="internal"><li><a class="tocitem" href="#Custom-reduction-functions"><span>Custom reduction functions</span></a></li><li><a class="tocitem" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists"><span>Preallocating auxiliary arrays: threaded output and cell lists</span></a></li></ul></li><li><a class="tocitem" href="../performance/">Performance</a></li><li><a class="tocitem" href="../reference/">Reference</a></li><li><a class="tocitem" href="../help/">Help entries</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Parallelization</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Parallelization</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/m3g/CellListMap.jl/blob/master/docs/src/parallelization.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Parallelization-splitting-and-reduction"><a class="docs-heading-anchor" href="#Parallelization-splitting-and-reduction">Parallelization splitting and reduction</a><a id="Parallelization-splitting-and-reduction-1"></a><a class="docs-heading-anchor-permalink" href="#Parallelization-splitting-and-reduction" title="Permalink"></a></h1><p>The parallel execution requires the splitting of the computation among threads, obviously. Thus, the output variable must be split and then reduced to avoid concurrency. To control these steps, set manually the <code>output_threaded</code> and <code>reduce</code> optional input parameters of the <code>map_pairwise!</code> function. </p><p>By default, we define (here <code>using Base.Threads</code>):</p><pre><code class="language-julia hljs">output_threaded = [ deepcopy(output) for i in 1:nthreads() ]</code></pre><p>and, for scalars and vectors, the reduction is just the sum of the output per thread:</p><pre><code class="language-julia hljs">reduce(output::Number,output_threaded) = sum(output_threaded)
function reduce(output::Vector,output_threaded) 
  for i in 1:nthreads()
     @. output += output_threaded[i] 
  end
  return output
end</code></pre><h2 id="Custom-reduction-functions"><a class="docs-heading-anchor" href="#Custom-reduction-functions">Custom reduction functions</a><a id="Custom-reduction-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-reduction-functions" title="Permalink"></a></h2><p>In some cases, as in the <a href="#nearest-neighbour">Nearest neighbour</a> example, the output is a tuple and reduction consists in keeping the output from each thread having the minimum value for the distance. Thus, the reduction operation is not a simple sum over the elements of each threaded output. We can, therefore, overwrite the default reduction method, by passing the reduction function as the <code>reduce</code> parameter of <code>map_pairwise!</code>:</p><pre><code class="language-julia hljs">mind = map_pairwise!( 
  (x,y,i,j,d2,mind) -&gt; f(i,j,d2,mind), mind,box,cl;
  reduce=reduce_mind
)</code></pre><p>where here the <code>reduce</code> function is set to be the custom function that keeps the tuple associated to the minimum distance obtained between threads:</p><pre><code class="language-julia hljs">function reduce_mind(output,output_threaded)
  mind = output_threaded[1]
  for i in 2:Threads.nthreads()
    if output_threaded[i][3] &lt; mind[3]
      mind = output_threaded[i]
    end
  end
  return mind
end</code></pre><p>This function <em>must</em> return the updated <code>output</code> variable, being it mutable or not, to be compatible with the interface.  </p><h2 id="Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists"><a class="docs-heading-anchor" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists">Preallocating auxiliary arrays: threaded output and cell lists</a><a id="Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-auxiliary-arrays:-threaded-output-and-cell-lists" title="Permalink"></a></h2><h3 id="Preallocating-the-cell-lists"><a class="docs-heading-anchor" href="#Preallocating-the-cell-lists">Preallocating the cell lists</a><a id="Preallocating-the-cell-lists-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-the-cell-lists" title="Permalink"></a></h3><p>The arrays containing the cell lists can be initialized only once, and then updated. This is useful for iterative runs. Note that, since the list size depends on the box size and cutoff, if the box properties changes some arrays might be increased (never shrinked) on this update. </p><pre><code class="language-julia hljs"># Initialize cell lists with initial coordinates
cl = CellList(x,box)
for i in 1:nsteps
  x = ... # new coordinates
  box = Box(sides,cutoff) # perhaps the box has changed
  cl = UpdateCellList!(x,box) 
end</code></pre><p>The procedure is identical if using two sets of coordinates, in which case, one would do:</p><pre><code class="language-julia hljs"># Initialize cell lists with initial coordinates
cl = CellList(x,y,box)
for i in 1:nsteps
  x = ... # new coordinates
  box = Box(sides,cutoff) # perhaps the box has changed
  cl = UpdateCellList!(x,y,box)
end</code></pre><h3 id="Preallocating-threaded-output-auxiliary-arrays"><a class="docs-heading-anchor" href="#Preallocating-threaded-output-auxiliary-arrays">Preallocating threaded output auxiliary arrays</a><a id="Preallocating-threaded-output-auxiliary-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-threaded-output-auxiliary-arrays" title="Permalink"></a></h3><p>On parallel runs, note that <code>output_threaded</code> is, by default, initialized on the call to <code>map_pairwise!</code>. Thus, if the calculation must be run multiple times (for example, for several steps of a trajectory), it is probably a good idea to preallocate the threaded output, particularly if it is a large array. For example, the arrays of forces should be created only once, and reset to zero after each use:</p><pre><code class="language-julia hljs">forces = zeros(SVector{3,Float64},N)
forces_threaded = [ deepcopy(forces) for i in 1:nthreads() ]
for i in 1:nsteps
  map_pairwise!(f, forces, box, cl, output_threaded=forces_threaded)
  # work with the final forces vector
  ...
  # Reset forces_threaded
  for i in 1:Threads.nthreads()
    @. forces_threaded[i] = zero(SVector{3,Float64}) 
  end
end</code></pre><p>In this case, the <code>forces</code> vector will be updated by the default reduction method.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pbc/">« Periodic conditions</a><a class="docs-footer-nextpage" href="../performance/">Performance »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Thursday 19 August 2021 20:33">Thursday 19 August 2021</span>. Using Julia version 1.6.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
